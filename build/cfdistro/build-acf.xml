<project name="build-acf" default="acf.build.war.localdev" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">

	<property name="ext.acf.dir" location="${ext.dir}/acf" />
	<property name="ext.acf.war" location="${ext.acf.dir}/9/cfusion.war" />

	<target name="acf.build" depends="clean">
		<unzip src="${ext.acf.war}"
		       dest="${war.temp.dir}">
<!--
		    <patternset>
		        <include name="**/*.java"/>
		        <exclude name="**/Test*.java"/>
		    </patternset>
-->		    
		</unzip>
		<copy file="${ext.acf.dir}/9/web-noflash.xml" tofile="${war.temp.dir}/WEB-INF/web.xml" overwrite="true" />
<!--
		<copy file="${ext.acf.war.dir}/WEB-INF/cfusion/lib/neo-runtime.xml" tofile="${war.temp.dir}/WEB-INF/cfusion/lib/neo-runtime.xml" overwrite="true" />
		<copy file="${ext.acf.war.dir}/WEB-INF/cfusion/lib/adminconfig.xml" tofile="${war.temp.dir}/WEB-INF/cfusion/lib/adminconfig.xml" overwrite="true" />
-->
		<echo file="${war.temp.dir}/WEB-INF/cfusion/lib/password.properties" message="rdspassword=${line.separator}password=${cfadmin.password}${line.separator}encrypted=false" />
		<echo file="${war.temp.dir}/WEB-INF/cfusion/lib/license.properties">
			<![CDATA[
#CF License File
#Sat Nov 21 15:21:42 MST 2009
appserver=0YV\#Y\!,U&;_;YN@)&)B'"WP  \n
code=-1789646309729322085
sn=Developer
listen=true
user=
trial_sn=
installlanguage=en
installtype=j2ee
company=
previous_sn=
vendor=0YV\#Y\!,U&;_;YN@)&)B'"WP  \n
			]]>
		</echo>
		<xmltask source="${war.temp.dir}/WEB-INF/cfusion/lib/adminconfig.xml" dest="${war.temp.dir}/WEB-INF/cfusion/lib/adminconfig.xml">
			<replace path="/setupconfig/runsetupwizard/text()" withText="false" />
			<replace path="/setupconfig/setupoptions/sampleapps/text()" withText="false" />
			<replace path="/setupconfig/setupoptions/enablerds/text()" withText="false" />
		</xmltask>
	</target>

	<target name="acf.war.build" depends="acf.build">
		<antcontrib:runtarget target="acf.mappings.xml.build" />
		<antcontrib:runtarget target="acf.customtags.xml.build" />
		<antcontrib:runtarget target="acf.add.libs" />
		<antcontrib:runtarget target="set.debug.acf" />
		<antcontrib:runtarget target="cfantrunner.install" />
	</target>
	
	<target name="acf.build.war.localdev" depends="acf.war.build">
	</target>
	
	<target name="set.debug.acf">
		<copy file="${ext.railo.dir}/error.cfm" todir="${war.temp.dir}/WEB-INF/debug" overwrite="true" />
		<xmltask source="${war.temp.dir}/WEB-INF/cfusion/lib/neo-debug.xml" dest="${war.temp.dir}/WEB-INF/cfusion/lib/neo-debug.xml">
			<attr path="//struct/var[@name='enabled']/boolean" attr="value" value="true"/>
			<attr path="//struct/var[@name='robust_enabled']/boolean" attr="value" value="true"/>
			<attr path="//struct/var[@name='requestvar']/boolean" attr="value" value="true"/>
			<replace path="//struct/var[@name='debug_template']/string/text()" withText="/WEB-INF/debug/error.cfm" />
		</xmltask>
	</target>
	
	<target name="acf.mappings.xml.build" depends="exists.mappings.xml" if="exists.mappings.xml">
	   <xmltask source="mappings.xml">
	      <call path="mappings/*">
	        <param name="virtual" path="@virtual" default="NONE"/>
	        <param name="physical" path="@physical" default="NONE"/>
	        <actions>
	        	<antcontrib:var name="mapping.exists" unset="true"/>
	      		<xmltask source="${war.temp.dir}/WEB-INF/cfusion/lib/neo-runtime.xml" dest="${war.temp.dir}/WEB-INF/cfusion/lib/neo-runtime.xml">
	  					<copy path="//data/array/struct[8]/var[@name='@{virtual}']/@name" attrValue="true" property="mapping.exists"/>
	  					<replace path="//data/array/struct[8]/var[@name='@{virtual}']" if="mapping.exists">
	  						<![CDATA[
	  						<var name="@{virtual}">
	  							<string>@{physical}</string>
	  						</var>
	  						]]>
	  					</replace>
	  					<insert path="//data/array/struct[8]" position="under" unless="mapping.exists">
	  						<![CDATA[
	  						<var name="@{virtual}">
	  							<string>@{physical}</string>
	  						</var>
	  						]]>
	  					</insert>
	  				</xmltask>
	        	<antcontrib:switch value="${mapping.exists}">
	        	  <case value="@{virtual}">
	        	    <echo message="Updated Mapping @{virtual} to @{physical}" />
	        	  </case>
	        	  <default>
	        	    <echo message="Added Mapping @{virtual} to @{physical}" />
	        	  </default>
	        	</antcontrib:switch>
	        </actions>
	      </call>  
	    </xmltask>  
	</target>	

	
	<target name="acf.customtags.xml.build" depends="exists.customtags.xml" if="exists.customtags.xml">
		<xmltask source="customtags.xml">
			<call path="mappings/*">
				<param name="virtual" path="@virtual" default="NONE" />
				<param name="physical" path="@physical" default="NONE" />
				<actions>
					<antcontrib:var name="mapping.exists" unset="true" />
					<xmltask source="${war.temp.dir}/WEB-INF/lib/railo-server/context/railo-server.xml" dest="${war.temp.dir}/WEB-INF/lib/railo-server/context/railo-server.xml">
						<copy path="/railo-configuration/custom-tag/mapping[@physical='@{physical}']/@physical" attrValue="true" property="mapping.exists" />
						<replace path="/railo-configuration/custom-tag/mapping[@physical=@{physical}]/text()" if="mapping.exists">
							<![CDATA[
	  					<mapping
	  						trusted="false"
	  						physical="@{physical}"
	  					/>
	  					]]>
	  					</replace>
						<insert path="/railo-configuration/custom-tag" position="under" unless="mapping.exists">
							<![CDATA[
	  					<mapping
	  						trusted="false"
	  						physical="@{physical}"
  						/>
	  					]]>
	  					</insert>
					</xmltask>
					<antcontrib:switch value="${mapping.exists}">
						<case value="@{physical}">
							<echo message="Updated Custom Tag Mapping - @{physical}" />
						</case>
						<default>
							<echo message="Added Custom Tag Mapping - @{physical}" />
						</default>
					</antcontrib:switch>
				</actions>
			</call>
		</xmltask>
	</target>
	
	<target name="acf.add.libs" if="add.libs.dir" unless="dont.add.libs">
		<echo message="Copying libs: ${add.libs.dir} to: ${war.temp.dir}/WEB-INF/cfusion/lib" /> 
		<copy todir="${war.temp.dir}/WEB-INF/cfusion/lib" overwrite="true">
			<fileset dir="${add.libs.dir}"/>
		</copy>
	</target>

	
	<target name="clean">
		<antcall target="cfdistro.clean"/>
	</target>
	
	<target name="copySources">
		<antcall target="cfdistro.copySources"/>
	</target>

	<target name="exists.mappings.xml">
		<antcall target="cfdistro.exists.mappings.xml" />
	</target>

	<target name="exists.datasources.xml">
		<antcall target="cfdistro.exists.datasources.xml" />
	</target>

	<target name="exists.customtags.xml">
		<antcall target="cfdistro.exists.customtags.xml" />
	</target>

	<target name="exists.mail.xml">
		<antcall target="cfdistro.exists.mail.xml" />
	</target>

</project>

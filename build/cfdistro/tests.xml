<project name="tests" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">

	<target name="tests.run">
		<mkdir dir="${war.temp.dir}" />
		<property name="testresult.file" value="${war.temp.dir}/test.results.html/" />
		<sequential>
			<echo message="running tests" />
			<get src="http://localhost:${runwar.port}/${war.name}/tests/run.cfm" dest="${testresult.file}" verbose="true" ignoreerrors="true" />
			<loadfile property="tesresults" srcFile="${testresult.file}" />
			<echo message="${tesresults}" />
			<sleep seconds="10" />
		</sequential>
	</target>

	<target name="tests.start.run.stop">
		<mkdir dir="${war.temp.dir}" />
		<property name="testresult.file" value="${war.temp.dir}/test.results.html" />
		<sequential>
			<antcontrib:runtarget target="runwar.start.background" />
			<antcontrib:runtarget target="tests.run" />
			<antcontrib:runtarget target="runwar.stop" />
		</sequential>
	</target>
	
	
	<target name="tests.build.start.run.stop">
		<mkdir dir="${war.temp.dir}" />
		<property name="testresult.file" value="${war.temp.dir}/test.results.html" />
		<sequential>
			<antcontrib:runtarget target="project.update" />
			<antcontrib:runtarget target="build.localdev.start" />
			<antcontrib:runtarget target="tests.run" />
			<antcontrib:runtarget target="runwar.stop" />
		</sequential>
	</target>

	<target name="tests.build.start.run.stop.both">
		<sequential>
			<antcontrib:var name="default.cfengine" value="railo" />
			<antcontrib:runtarget target="tests.build.start.run.stop" />
			<antcontrib:var name="default.cfengine" value="acf" />
			<antcontrib:runtarget target="tests.build.start.run.stop" />
		</sequential>
	</target>

	<target name="tests.build.start.run.stop.ifnew">
		<mkdir dir="${war.temp.dir}" />
		<property name="testresult.file" value="${war.temp.dir}/test.results.html/" />
		<sequential>
			<antcontrib:runtarget target="project.update" />
			<antcontrib:if>
				<equals arg1="${revisions.are.same}" arg2="true" />
				<then>
					<echo message="Revisions are the same, not running tests" />
				</then>
				<else>
					<echo message="Revisions differ, running tests" />
					<sequential>
						<antcontrib:runtarget target="build.localdev" />
						<antcontrib:runtarget target="tests.build.start.run.stop" />
					</sequential>
				</else>
			</antcontrib:if>
		</sequential>
	</target>
</project>